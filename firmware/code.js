(()=>{"use strict";var e,n=function(e){var n=this;this.debounceTime=e,this.subscribers=[],this.subscribe=function(e){return n.subscribers.push(e)},this.once=function(e){var t=function(r){e(r),n.unsubscribe(t)};n.subscribers.push(t)},this.unsubscribe=function(e){return n.subscribers=n.subscribers.filter((function(n){return n!==e}))},this.publish=function(e){if(n.debounceTime){var t=getTime();(n.previousTime?t-n.previousTime:n.debounceTime)>=n.debounceTime&&(n.previousTime=t,n.subscribers.forEach((function(n){return n(e)})))}else n.subscribers.forEach((function(n){return n(e)}))}};!function(e){e[e.Next=1]="Next",e[e.Previous=2]="Previous",e[e.SetTrack=3]="SetTrack",e[e.IncreaseVolume=4]="IncreaseVolume",e[e.DecreaseVolume=5]="DecreaseVolume",e[e.SetVolume=6]="SetVolume",e[e.SetEQ=7]="SetEQ",e[e.SetMode=8]="SetMode",e[e.SetSource=9]="SetSource",e[e.Standby=10]="Standby",e[e.Resume=11]="Resume",e[e.Reset=12]="Reset",e[e.Play=13]="Play",e[e.Pause=14]="Pause",e[e.SetFolder=15]="SetFolder",e[e.SetGain=16]="SetGain",e[e.RepeatPlay=17]="RepeatPlay",e[e.Init=63]="Init",e[e.QueryStatus=66]="QueryStatus",e[e.QueryVolume=67]="QueryVolume",e[e.QueryEQ=68]="QueryEQ",e[e.QueryMode=69]="QueryMode",e[e.QuerySoftwareVersion=70]="QuerySoftwareVersion",e[e.QueryTotalFilesOnTFCard=71]="QueryTotalFilesOnTFCard",e[e.QueryTotalFilesOnUDisk=72]="QueryTotalFilesOnUDisk",e[e.QueryTotalFilesOnFlash=73]="QueryTotalFilesOnFlash",e[e.QueryCurrentTrackOnTFCard=75]="QueryCurrentTrackOnTFCard",e[e.QueryCurrentTrackOnUDisk=76]="QueryCurrentTrackOnUDisk",e[e.QueryCurrentTrackOnFlash=77]="QueryCurrentTrackOnFlash"}(e||(e={}));var t,r=function(e,n,t,r){var u=-(261+e+(n?1:0)+t+r);return[126,255,6,e,n?1:0,t,r,function(e){return e>>8}(u),function(e){return 255&e}(u),239]},u=function(){function t(t,u,i,o){var a=this;this.serial=o,this.busyStream=new n,this.busy=!1,this.playNext=function(){return a.run(e.Next)},this.playPrevious=function(){return a.run(e.Previous)},this.increaseVolume=function(){return a.run(e.IncreaseVolume)},this.decreaseVolume=function(){return a.run(e.DecreaseVolume)},this.volume=function(n){void 0!==n?a.run(e.SetVolume,n):a.run(e.QueryVolume)},this.eq=function(n){void 0!==n?a.run(e.SetEQ,n):a.run(e.QueryEQ),a.run(e.SetEQ,n)},this.mode=function(n){void 0!==n?a.run(e.SetMode,n):a.run(e.QueryMode)},this.setSource=function(n){return a.run(e.SetSource,n)},this.standby=function(){return a.run(e.Standby)},this.resume=function(){return a.run(e.Resume)},this.reset=function(){return a.run(e.Reset)},this.play=function(n,t){return new Promise((function(r,u){a.busy?u("DFPlayer is busy"):(a.busy=!0,a.busyStream.once(r),a.run(e.SetFolder,t,n))}))},this.pause=function(){return a.run(e.Pause)},this.setPlaybackFolder=function(n){return a.run(e.SetFolder,(t=n,1,10,Math.max(1,Math.min(10,t))));var t},this.setGain=function(n){var t=Math.max(0,Math.min(31,n));a.run(e.SetGain,t)},this.setRepeat=function(n){void 0===n&&(n=!1),a.run(e.RepeatPlay,Number(n))},this.getStatus=function(){a.run(e.QueryStatus)},i.mode("input"),this.busyStream.subscribe((function(){return a.busy=!1})),setWatch((function(e){return a.busyStream.publish(e)}),i,{repeat:!0,edge:"rising",debounceTime:100});var s="";o.setup(9600,{tx:t,rx:u}),o.on("data",(function(e){for(s+=e;s.length>=10;){var n=s.slice(0,10).split("").map((function(e){return(256+e.charCodeAt(0)).toString(16).substr(-2).toUpperCase()}));s=s.slice(10),console.log("resp",n.join(" "))}})),setTimeout((function(){return o.write(r(e.Init,!0,0,0))}),3e3)}return t.prototype.run=function(e,n,t){void 0===n&&(n=0),void 0===t&&(t=0);var u=r(e,!0,t,n);console.log("req",u.map((function(e){return e.toString(16)})).join(" ")),this.serial.write(u)},t}(),i=function(e){return function(n){e.mode("input"),setWatch(n,e,{repeat:!0,edge:"both",debounce:10})}};!function(e){e[e.POWER=378130479]="POWER",e[e.MINUS=378134559]="MINUS",e[e.PLUS=378132519]="PLUS",e[e.RED=378077439]="RED",e[e.GREEN=378126399]="GREEN",e[e.BLUE=378110079]="BLUE",e[e.CROSS=378114159]="CROSS",e[e.SQUARE=378118239]="SQUARE",e[e.TRIANGLE=378093759]="TRIANGLE",e[e.TOP_LEFT=378097839]="TOP_LEFT",e[e.TOP=378101919]="TOP",e[e.TOP_RIGHT=378099879]="TOP_RIGHT",e[e.LEFT=378081519]="LEFT",e[e.PLAY=378091719]="PLAY",e[e.RIGHT=378116199]="RIGHT",e[e.BOTTOM_LEFT=378083559]="BOTTOM_LEFT",e[e.BOTTOM=378124359]="BOTTOM",e[e.BOTTOM_RIGHT=378085599]="BOTTOM_RIGHT",e[e.X=378089679]="X",e[e.Y=378122319]="Y",e[e.Z=378105999]="Z"}(t||(t={}));var o,a,s,c,l=function(e,n,t){return n.mode("output"),e.mode("output"),analogWrite(e,0,{freq:t}),function(t){n.write(t>0),analogWrite(e,E.clip(Math.abs(t),0,1),null)}},f=l(P5,P4,100),d=l(P6,P7,100),h={OLED_WIDTH:128,OLED_CHAR:64,OLED_CHUNK:128},T=function(e,n,t){var r=0,u=1,i=null,o=null,a=0;n((function(){a+=u,o&&o(a)&&(r=0,e(0),i&&i())}));var s=null;return function(n){return u=n.direction?1:-1,0===r&&(r=n.startSpeed||.3),o=n.stopCondition,r=Math.min(1,1.05*r),e(r*(t?1:-1)*u),s||(s=new Promise((function(e,n){i=function(){e(a),a=0,s=null,i=null}}))),s}},m={oledReady:new n,irCodes:new n(.1)},p=function(){PrimaryI2C.setup({sda:SDA,scl:SCL});var e=function(e,n,t){var r=new Uint8Array([174,213,128,168,63,211,0,64,141,20,32,0,161,200,218,18,129,207,217,241,219,64,164,166,175]),u=[33,0,h.OLED_WIDTH-1,34,0,7],i=Graphics.createArrayBuffer(h.OLED_WIDTH,r[4]+1,1,{vertical_byte:!0});i.setRotation(2,!1);var o=60;return setTimeout((function(){r.forEach((function(n){e.writeTo(o,[0,n])}))}),50),void 0!==n&&setTimeout(n,100),i.flip=function(){u.forEach((function(n){e.writeTo(o,[0,n])}));var n=new Uint8Array(h.OLED_CHUNK+1);n[0]=h.OLED_CHAR;for(var t=0;t<this.buffer.length;t+=h.OLED_CHUNK)n.set(new Uint8Array(this.buffer,t,h.OLED_CHUNK),1),e.writeTo(o,n)},i.setContrast=function(n){return e.writeTo(o,0,129,n)},i.off=function(){return e.writeTo(o,0,174)},i.on=function(){return e.writeTo(o,0,175)},i}(PrimaryI2C,(function(){return m.oledReady.publish()})),n=i(P10),t=i(P11);!function(e,n){e.mode("input_pullup");var t=0,r=0,u=null,i=function(){0!=t&&(1===t?n(r):(n(t),r=t),t=0)};setWatch((function(e){var n=e.time-e.lastTime;null!==u&&(clearTimeout(u),u=null),n>.04?i():(t=t<<1|+(n>8e-4),u=setTimeout((function(){u=null,i()}),50))}),e,{repeat:!0,edge:"falling"})}(P3,(function(e){return m.irCodes.publish(e)}));var r,o,a=T(d,t,!1),s=T(f,n,!0),c=new u(P1,P0,P2,PrimarySerial);return{head:(r=P8,90,.675,2.325,o=function(e,n){switch(n){case"us":e=E.clip(e,675,2325),analogWrite(r,e/1e3/20,{freq:50});break;case"ms":e=E.clip(e,.675,2.325),analogWrite(r,e/20,{freq:50});break;default:e=E.clip(e,0,180),analogWrite(r,.03375+.0004583333333333333*(e-0),{freq:50})}},o(90),o),leftWheel:a,rightWheel:s,oled:e,mp3:c}}(),b={width:128,height:64,bpp:1,buffer:require("heatshrink").decompress(atob("AA0f/ANLgP/AAWAB5N/B4f+BxEPBwYAB+APHBYXgg4ECBwwKCCovgB4s/BAoWB/guGA4wXBMQgXBE4wIGj5HHFAKUEv6aIj6CEFw4wDIAUDVBK2B4CcCU5I6BUQTZLBYc/HxBACFYQzDgIXCj5LEIYQHDUIU/C4YMBCQQnFv43Dv/ADQZjBCgT+EJgMHLwYPIj/gh4PFIgIPEh/wj4GEB5H4EIIvLHoKOEB5BdBOwZvJB4JxBAwYPCDAkB/1/doavHB44AIB6H/B57eDABQPQH75veB4KmDB5S2DVoQADj7fEawIUBB4o6CB4MfB4MDfoR7EFQMH/Ef+BkCKYgGDh/4AIIYCEYIACEwcP+AhBHAQjBAAUPIwQ9BIIIFBn4DCAopdBEohADHwIlCRoJFDCYI0Cj5eCBgYGCeoXwEYIoCFgaQCAYIMBAAI+Cg5SDFYUHB4YXCBYZmDGAQuDPAgzBLgQEBDwZOBdgadFAAY2BXAd/dww+CdAh4BB46GDEoYwGBA55DYAj3FA4QXEDwIXGRoQmENBCcDUQZXHZYQADTgQAGv4ODPggAFVAIACLgqaHUg4A=="))},v=function(e){var n=o[e];n&&n(),o.default&&o.default(e)},y=function(e){o=e,m.irCodes.unsubscribe(v),m.irCodes.subscribe(v)},S=new n,B=0,P=0,C=!1,A=function(){return new Promise((function(e,n){a||(C=!1,a=setInterval((function(){var n;(B+=1)>59?(B=0,P++):B<0&&(B=59,P--),S.publish((n=function(e){return e>9?""+e:"0"+e})(P)+":"+n(B)),C||(C=!0,e())}),1e3))}))},O=!0,I=!1,Q=[],g=null,w=function(e,n){var t=function(){return null==s},r=p.leftWheel({direction:e,stopCondition:t}),u=p.rightWheel({direction:n,stopCondition:t});g||(g=Promise.all([r,u])).then((function(e){var n=e[0],t=e[1];Q.push([n,t]),g=null}))},D=function(){if(0!==Q.length&&!g){var e=Q[Q.length-1],n=e[0],t=e[1],r=Promise.resolve(0),u=function(e){var n=e;return function(t){var r=Math.abs(t+e);return print(r),r<n?(n=r,!1):(n=0,!0)}},i=0==n?r:p.leftWheel({direction:n<0,stopCondition:u(n)}),o=0==t?r:p.rightWheel({direction:t<0,stopCondition:u(t)});(g=Promise.all([i,o])).then((function(){setTimeout((function(){Q.splice(-1,1),g=null,D()}),1e3)}))}},F=(c=[["Timer",function(){p.oled.setFontVector(40),S.subscribe((function(e){p.oled.clear(),p.oled.drawString(e,0,10),p.oled.flip()})),A().then((function(){var e;return y(((e={})[t.PLAY]=function(){a?(clearInterval(a),a=null):A()},e[t.CROSS]=function(){clearInterval(a),a=null,B=0,P=0,F()},e))}))}],["Marsohod",function(){var e;p.oled.clear(),p.oled.drawImage(b,0,0),p.oled.flip(),y(((e={})[t.TOP]=function(){return w(O,O)},e[t.BOTTOM]=function(){return w(I,I)},e[t.LEFT]=function(){return w(I,O)},e[t.RIGHT]=function(){return w(O,I)},e[t.PLUS]=function(){return p.head(55)},e[t.MINUS]=function(){return p.head(125)},e[t.GREEN]=function(){return p.head(90)},e[t.PLAY]=function(){g||D()},e[t.CROSS]=F,e.default=function(){s&&clearTimeout(s),s=setTimeout((function(){s=null}),150)},e))}],["music",function(){var e;y(((e={})[t.LEFT]=function(){p.mp3.play(1,1).then((function(){return p.mp3.play(1,2)})).then((function(){return p.mp3.play(2,1)})).then((function(){return p.mp3.play(2,2)})).then((function(){return p.mp3.play(2,3)}))},e[t.RIGHT]=function(){return p.mp3.playPrevious()},e[t.TOP]=function(){return p.mp3.increaseVolume()},e[t.BOTTOM]=function(){return p.mp3.decreaseVolume()},e[t.CROSS]=function(){p.mp3.pause(),F()},e))}]],function(){var e,n=0,r=function(){p.oled.setFontVector(15),p.oled.clear();for(var e=0;e<c.length;e++){var t=c[e],r=t[0],u=(t[1],e===n?"> "+r:"  "+r);p.oled.drawString(u,0,20*e)}p.oled.flip()},u=((e={})[t.TOP]=function(){n=Math.max(0,n-1),r()},e[t.BOTTOM]=function(){n=Math.min(c.length-1,n+1),r()},e[t.PLAY]=function(){var e=c[n];e[0],(0,e[1])()},e);r(),y(u)});m.oledReady.subscribe((function(){p.oled&&(p.oled.clear(),p.oled.setFontVector(15),p.oled.drawImage(b,0,0),p.oled.flip()),setTimeout(F,5e3)}))})();
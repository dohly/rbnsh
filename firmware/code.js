(()=>{"use strict";var e,t=function(e){var t=this;this.debounceTime=e,this.subscribers=[],this.subscribe=function(e){return t.subscribers.push(e)},this.once=function(e){var r=function(n){e(n),t.unsubscribe(r)};t.subscribers.push(r)},this.unsubscribe=function(e){return t.subscribers=t.subscribers.filter((function(t){return t!==e}))},this.publish=function(e){if(t.debounceTime){var r=getTime();(t.previousTime?r-t.previousTime:t.debounceTime)>=t.debounceTime&&(t.previousTime=r,t.subscribers.forEach((function(t){return t(e)})))}else t.subscribers.forEach((function(t){return t(e)}))}};!function(e){e[e.Next=1]="Next",e[e.Previous=2]="Previous",e[e.SetTrack=3]="SetTrack",e[e.IncreaseVolume=4]="IncreaseVolume",e[e.DecreaseVolume=5]="DecreaseVolume",e[e.SetVolume=6]="SetVolume",e[e.SetEQ=7]="SetEQ",e[e.SetMode=8]="SetMode",e[e.SetSource=9]="SetSource",e[e.Standby=10]="Standby",e[e.Resume=11]="Resume",e[e.Reset=12]="Reset",e[e.Play=13]="Play",e[e.Pause=14]="Pause",e[e.SetFolder=15]="SetFolder",e[e.SetGain=16]="SetGain",e[e.RepeatPlay=17]="RepeatPlay",e[e.Init=63]="Init",e[e.QueryStatus=66]="QueryStatus",e[e.QueryVolume=67]="QueryVolume",e[e.QueryEQ=68]="QueryEQ",e[e.QueryMode=69]="QueryMode",e[e.QuerySoftwareVersion=70]="QuerySoftwareVersion",e[e.QueryTotalFilesOnTFCard=71]="QueryTotalFilesOnTFCard",e[e.QueryTotalFilesOnUDisk=72]="QueryTotalFilesOnUDisk",e[e.QueryTotalFilesOnFlash=73]="QueryTotalFilesOnFlash",e[e.QueryCurrentTrackOnTFCard=75]="QueryCurrentTrackOnTFCard",e[e.QueryCurrentTrackOnUDisk=76]="QueryCurrentTrackOnUDisk",e[e.QueryCurrentTrackOnFlash=77]="QueryCurrentTrackOnFlash"}(e||(e={}));var r,n=function(e,t,r,n){var u=-(261+e+(t?1:0)+r+n);return[126,255,6,e,t?1:0,r,n,function(e){return e>>8}(u),function(e){return 255&e}(u),239]},u=function(){function r(r,u,i,o,s){var a=this;this.busy=i,this.serial=o,this.busyStream=new t,this.playNext=function(){return a.run(e.Next)},this.playPrevious=function(){return a.run(e.Previous)},this.increaseVolume=function(){return a.run(e.IncreaseVolume)},this.decreaseVolume=function(){return a.run(e.DecreaseVolume)},this.volume=function(t){void 0!==t?a.run(e.SetVolume,t):a.run(e.QueryVolume)},this.eq=function(t){void 0!==t?a.run(e.SetEQ,t):a.run(e.QueryEQ),a.run(e.SetEQ,t)},this.mode=function(t){void 0!==t?a.run(e.SetMode,t):a.run(e.QueryMode)},this.setSource=function(t){return a.run(e.SetSource,t)},this.standby=function(){return a.run(e.Standby)},this.resume=function(){return a.run(e.Resume)},this.reset=function(){return a.run(e.Reset)},this.play=function(t,r){return new Promise((function(n,u){0==a.busy.read()?u("DFPlayer is busy"):(a.busyStream.once(n),a.run(e.SetFolder,r,t))}))},this.pause=function(){return a.run(e.Pause)},this.setPlaybackFolder=function(t){return a.run(e.SetFolder,(r=t,1,10,Math.max(1,Math.min(10,r))));var r},this.setGain=function(t){var r=Math.max(0,Math.min(31,t));a.run(e.SetGain,r)},this.setRepeat=function(t){void 0===t&&(t=!1),a.run(e.RepeatPlay,Number(t))},this.getStatus=function(){a.run(e.QueryStatus)},i.mode("input"),setWatch((function(e){e.state&&setTimeout((function(){return a.busyStream.publish(e.state)}),200),s.write(!e.state)}),i,{repeat:!0,edge:"both",debounceTime:100});var c="";o.setup(9600,{tx:r,rx:u}),o.on("data",(function(e){for(c+=e;c.length>=10;){var t=c.slice(0,10).split("").map((function(e){return(256+e.charCodeAt(0)).toString(16).substr(-2).toUpperCase()}));c=c.slice(10),console.log("resp",t.join(" "))}})),setTimeout((function(){return o.write(n(e.Init,!0,0,0))}),3e3)}return r.prototype.run=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0);var u=n(e,!0,r,t);this.serial.write(u)},r}(),i=function(e){return function(t){e.mode("input"),setWatch(t,e,{repeat:!0,edge:"both",debounce:10})}};!function(e){e[e.POWER=378130479]="POWER",e[e.MINUS=378134559]="MINUS",e[e.PLUS=378132519]="PLUS",e[e.RED=378077439]="RED",e[e.GREEN=378126399]="GREEN",e[e.BLUE=378110079]="BLUE",e[e.CROSS=378114159]="CROSS",e[e.SQUARE=378118239]="SQUARE",e[e.TRIANGLE=378093759]="TRIANGLE",e[e.TOP_LEFT=378097839]="TOP_LEFT",e[e.TOP=378101919]="TOP",e[e.TOP_RIGHT=378099879]="TOP_RIGHT",e[e.LEFT=378081519]="LEFT",e[e.PLAY=378091719]="PLAY",e[e.RIGHT=378116199]="RIGHT",e[e.BOTTOM_LEFT=378083559]="BOTTOM_LEFT",e[e.BOTTOM=378124359]="BOTTOM",e[e.BOTTOM_RIGHT=378085599]="BOTTOM_RIGHT",e[e.X=378089679]="X",e[e.Y=378122319]="Y",e[e.Z=378105999]="Z"}(r||(r={}));var o=function(e,t,r){return t.mode("output"),e.mode("output"),analogWrite(e,0,{freq:r}),function(r){t.write(r>0),analogWrite(e,E.clip(Math.abs(r),0,1),null)}},s=o(P5,P4,100),a=o(P6,P7,100),c={OLED_WIDTH:128,OLED_CHAR:64,OLED_CHUNK:128},l=function(e,t,r){var n=0,u=1,i=null,o=null,s=0;t((function(){s+=u,o&&o(s)&&(n=0,e(0),i&&i())}));var a=null;return function(t){return u=t.direction?1:-1,0===n&&(n=t.startSpeed||.3),o=t.stopCondition,n=Math.min(1,1.05*n),e(n*(r?1:-1)*u),a||(a=new Promise((function(e,t){i=function(){e(s),s=0,a=null,i=null}}))),a}},f={oledReady:new t,irCodes:new t(.1)},T=function(){PrimaryI2C.setup({sda:SDA,scl:SCL});var e=function(e,t,r){var n=new Uint8Array([174,213,128,168,63,211,0,64,141,20,32,0,161,200,218,18,129,207,217,241,219,64,164,166,175]),u=[33,0,c.OLED_WIDTH-1,34,0,7],i=Graphics.createArrayBuffer(c.OLED_WIDTH,n[4]+1,1,{vertical_byte:!0});i.setRotation(2,!1);var o=60;return setTimeout((function(){n.forEach((function(t){e.writeTo(o,[0,t])}))}),50),void 0!==t&&setTimeout(t,200),i.flip=function(){u.forEach((function(t){e.writeTo(o,[0,t])}));var t=new Uint8Array(c.OLED_CHUNK+1);t[0]=c.OLED_CHAR;for(var r=0;r<this.buffer.length;r+=c.OLED_CHUNK)t.set(new Uint8Array(this.buffer,r,c.OLED_CHUNK),1),e.writeTo(o,t)},i.setContrast=function(t){return e.writeTo(o,0,129,t)},i.off=function(){return e.writeTo(o,0,174)},i.on=function(){return e.writeTo(o,0,175)},i}(PrimaryI2C,(function(){try{f.oledReady.publish()}catch(e){setTimeout((function(){return f.oledReady.publish()}),400)}})),t=i(P10),r=i(P11);!function(e,t){e.mode("input_pullup");var r=0,n=0,u=null,i=function(){0!=r&&(1===r?t(n):(t(r),n=r),r=0)};setWatch((function(e){var t=e.time-e.lastTime;null!==u&&(clearTimeout(u),u=null),t>.04?i():(r=r<<1|+(t>8e-4),u=setTimeout((function(){u=null,i()}),50))}),e,{repeat:!0,edge:"falling"})}(P3,(function(e){return f.irCodes.publish(e)}));var n,o,T=l(a,r,!1),h=l(s,t,!0),m=new u(P1,P0,P2,PrimarySerial,P9);return{head:(n=P8,90,.675,2.325,o=function(e,t){switch(t){case"us":e=E.clip(e,675,2325),analogWrite(n,e/1e3/20,{freq:50});break;case"ms":e=E.clip(e,.675,2.325),analogWrite(n,e/20,{freq:50});break;default:e=E.clip(e,0,180),analogWrite(n,.03375+.0004583333333333333*(e-0),{freq:50})}},o(90),o),leftWheel:T,rightWheel:h,oled:e,mp3:m}}(),h=(T.mp3,T.oled);setTimeout((function(){var e=new Waveform(128,{doubleBuffer:!0});e.on("buffer",(function(e){h.clear(),h.moveTo(0,32),e.forEach((function(e,t){return h.lineTo(t,e/4)})),h.flip()})),e.startInput(A2,2e3,{repeat:!0})}),4e3)})();